<!--#layout("/common/layout.html",{"title":"数据字典"}){ -->


<form class="layui-form toolbar" id="tableToolBar" action="javascript:;">
    <div class="layui-form-item">
        <w:inputText label="字典编码" name="param@like@type" inline="true"></w:inputText>
        <w:inputText label="编码描述" name="param@like@type_name" inline="true"></w:inputText>
        <w:inputText label="名称" name="param@like@name" inline="true"></w:inputText>
        <w:inputText label="值" name="param@like@value" inline="true"></w:inputText>
        <w:inputDate label="创建时间" name="param@between@ctime" id="param_ctime" range="true" inline="true"></w:inputDate>
        <div class="layui-inline">
            <w:accessButton label="搜索" icon="layui-icon layui-icon-search" action="search"></w:accessButton>
            <w:accessButton label="添加" icon="layui-icon layui-icon-add-circle" action="insert"></w:accessButton>
            <w:accessButton label="删除" icon="layui-icon layui-icon-delete" action="delete"></w:accessButton>
        </div>
    </div>
</form>

<table class="layui-table" id="table" lay-filter="table"></table>

<script>
    layui.use(['layer', 'form', 'table', 'util', 'admin', 'laydate', 'upload'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var table = layui.table;
        var util = layui.util;
        var admin = layui.admin;
        var laydate = layui.laydate;
        var upload = layui.upload;
        var REQUEST_PATH = "${ctxPath}/core/dict/";

        var initComponent = function () {


            upload.render({
                elem: '#upload-thumb'
                ,url: '${ctxPath}/system/upload/video/1'
                ,accept: 'images'
                ,before: function(obj){
                    obj.preview(function(index, file, result){
                        $('#img-thumb').attr('src', result);
                    });
                }
                ,done: function(res){
                    if(res.code !== 200){
                        return layer.msg('上传失败');
                    }

                    // SUCCESS
                    $('input[name=cover]').val(res.data.records[0].fileName);
                }
                ,error: function(){
                    $('#img-thumb').attr('src', '');
                    layer.msg('上传失败，请重新上传')
                }
            });




        };
        initComponent();

        // 渲染表格
        var insTb = table.render({
            elem: '#table',
            url: REQUEST_PATH + 'query',
            page: true,
            cellMinWidth: 100,
            limit: 20,
            limits: [10, 20, 50, 100, 200, 999],
            cols: [[
                {type: 'checkbox'},
                {field: 'orders', align: 'left', title: '排序', sort: true, edit: true, width: 90},
                {field: 'type', align: 'left', title: '字典编码', sort: true, edit: true},
                {field: 'typeName', align: 'left', title: '编码描述', sort: true, edit: true},
                {field: 'name', align: 'left', title: '名称', sort: true, edit: true},
                {field: 'value', align: 'left', title: '值', sort: true, edit: true},
                {align: 'center', toolbar: '#tableBar', title: '操作', width: 240}
            ]],
            done: function (res, curr, count) {
                $('.td-img').on('mouseover', function(){
                    var that = this;
                    var src = $(that).attr('src');
                    layer.tips('<img style="max-height: 200px;" src="'+ src +'">', that, {time: -1, tips: 1});
                }).on('mouseleave', function () {
                    layer.closeAll('tips')
                });
            }
        });

        // 工具条点击事件
        table.on('tool(table)', function (obj) {
            var data = obj.data;
            var layEvent = obj.event;
            if (layEvent === 'edit') { // 编辑
                showEditModel(data);
            } else if (layEvent === 'del') { // 删除
                doDel(data.id, '');
            } else if (layEvent === 'reUpload') {  // 重传
                admin.open({
                    type: 2,
                    title: '维护视频链接',
                    content: '${ctxPath}/system/videoUrl/?videoId=' + data.id,
                    area: ['94%', '90%'],
                    success: function (layero, dIndex) {

                    }
                });
            } else if (layEvent === 'tag') {
                var videoId = data.id;
                var tagListStr = data.tagListStr;
                console.log(tagListStr)


            }
        });

        // 表格编辑事件
        table.on('edit(table)', function(obj){
            var data = {
                id: obj.data.id
            };
            data[obj.field] = obj.value;
            admin.req(REQUEST_PATH + 'update', data, function (res) {
                admin.handleMessage(res);
            }, 'post');
        });

        // 表格排序事件
        table.on('sort(table)', function(obj){
            table.reload('table', {
                initSort: obj
                ,where: {
                    field: obj.field
                    ,type: obj.type
                }
            });
        });


        var toolbar = {
            insert: function () {

            },
            delete: function () {

            },
            export: function () {

            }
        };

        $('.ext-toolbar').on('click', function() {
            var type = $(this).data('type');
            toolbar[type] ? toolbar[type].call(this) : '';
        });

        // 添加
        $('#btnAdd').click(function () {
            showEditModel();
        });

        // 搜索
        form.on('submit(toolbarSearch)', function (data) {
            insTb.reload({
                where: data.field
                ,page: {
                    curr: 1
                }
            });
            return false;
        });

        // 导出
        form.on('submit(toolbarExport)', function (data) {
            top.notice.msg('正在解析数据，请稍候...', {icon: 5, timeout: 1300});
            var u = REQUEST_PATH + "export/excel?1=1";
            for(var key in data.field) {
                u += ('&' + key + '=' + data.field[key])
            }
            window.location.href = u;
            return false;
        });

        // 多选删除
        $('#btnDelete').click(function () {
            doDel();
        });

        // 显示表单弹窗
        function showEditModel(mData) {
            admin.open({
                type: 1,
                title: (mData ? '修改' : '添加') + '视频信息',
                content: $('#modal'),
                area: ['94%', '600px'],
                success: function (layero, dIndex) {
                    $(layero).children('.layui-layer-content').css('overflow-x', 'visible');
                    var url = mData ? 'update' : 'insert';
                    // 回显数据
                    if (mData) {
                        $('#img-thumb').attr('src', mData.coverFull);
                        form.val('modalForm', mData);
                    } else {
                        $('#img-thumb').attr('src', '');
                    }
                    form.render();

                    // 更新/添加
                    form.on('submit(modalSubmit)', function (data) {
                        layer.load(2);
                        var d = data.field;
                        admin.req(REQUEST_PATH + url, d, function (res) {
                            layer.closeAll('loading');
                            admin.handleMessage(res, function () {
                                layer.close(dIndex);
                                insTb.reload();
                            });
                        });
                        return false;
                    });
                },
                end: function () {
                    $('#modalForm')[0].reset();
                    form.render();
                }
            });
        }

        // 删除 (id仅支持单个id，不传则获取选中行id)
        function doDel(id, title) {
            var tipTitle = title === undefined ? '确认要删除吗？' : '确定要删除吗？';
            var ids = [];
            if (typeof(id) === 'number' || typeof(id) === 'string') {
                ids.push(id);
            } else {
                // 获取选中行
                var checkRows = table.checkStatus('table');
                if (checkRows.data.length != 0) {
                    layui.each(checkRows.data, function (i, item) {
                        ids.push(item.id);
                    });
                } else {
                    var o = {title: '提示', message: '请勾选要删除的数据', position: 'topRight'};
                    top.notice.warning(o);
                }
            }

            top.layer.confirm(tipTitle, {
                skin: 'layui-layer-admin'
            }, function (i) {
                layer.load(2);
                admin.req(REQUEST_PATH + 'delete', {
                    ids: ids.join(',')
                }, function (res) {
                    layer.closeAll('loading');
                    admin.handleMessage(res, function () {
                        insTb.reload();
                        top.layer.closeAll();
                    });
                });
            });
        }

    });
</script>



<!--#}-->

